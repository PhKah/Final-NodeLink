# Nâng cấp Toàn diện Bộ Test (Comprehensive Test Suite Upgrade)

- **Người thực hiện (Implemented by):** Gemini
- **Liên quan đến Giai đoạn (Related to Phase):** 2 & 3

---

## 📝 Kế hoạch thực thi (Execution Plan)

*Phần này mô tả kế hoạch chi tiết sẽ được thực hiện. Gemini sẽ trình bày những gì sẽ làm và lý do tại sao. Công việc sẽ chỉ bắt đầu sau khi bạn đồng ý với kế hoạch này.*

**1. Mục tiêu (Goal):**
*   Tái cấu trúc bộ test `tests/node-link.ts` thành một bài kiểm tra tích hợp có khả năng mở rộng, dựa trên kịch bản thực tế. Kịch bản này sẽ mô phỏng một quy trình làm việc hoàn chỉnh với `N` renter và `N` provider, cùng với logic xác thực công việc rõ ràng từ đầu đến cuối.

**2. Lý do (Reason):**
*   Bộ test hiện tại chỉ kiểm tra một luồng cơ bản, đơn lẻ và đã trở nên lỗi thời sau các bản sửa lỗi gần đây. Việc nâng cấp là cần thiết để:
    *   Đảm bảo hệ thống hoạt động ổn định với nhiều người dùng hoạt động đồng thời.
    *   Xác thực logic nghiệp vụ end-to-end một cách chính xác, từ việc tạo job, thực thi, cho đến xác minh kết quả.
    *   Tạo ra một bộ test linh hoạt, dễ dàng điều chỉnh quy mô (thông qua hằng số `N`) để kiểm tra hiệu năng và phát hiện các vấn đề tiềm ẩn khi hệ thống mở rộng.

**3. Các bước thực hiện (Steps):**

*   **Giai đoạn 1: Dựng Gerüst (Scaffolding) và Dọn dẹp**
    1.  Tạo thư mục `tests/test-jobs` và file `add_job.json` để định nghĩa job mẫu.
    2.  Xóa file test cũ và không còn phù hợp `tests/node-link.js`.

*   **Giai đoạn 2: Nâng cấp các Công cụ CLI**
    1.  **`provider-cli.ts`:** Sửa đổi lệnh `listen` để có thể đọc file job từ `job_details`, thực thi phép tính "add" trong file JSON, và submit kết quả đúng lên blockchain.
    2.  **`renter-cli.ts`:** Sửa đổi lệnh `create-job` để chấp nhận đường dẫn file job trong tham số `--details`.

*   **Giai đoạn 3: Tái cấu trúc Bộ Test `tests/node-link.ts`**
    1.  **Setup:** Định nghĩa hằng số `const N` để quy định số lượng Renter/Provider. Tạo hàm tiện ích `airdrop(publicKey)`.
    2.  **Khối `before`:** Dùng vòng lặp để tạo `N` renter, `N` provider, lưu keypair, cấp SOL, và đăng ký tất cả các provider.
    3.  **Khối `after`:** Dọn dẹp tất cả các tiến trình listener và file keypair tạm.
    4.  **Khối `it` (Test chính):**
        *   Khởi chạy `N` listener cho `N` provider chạy ngầm.
        *   Dùng `Promise.all` để `N` renter đồng thời tạo job.
        *   Viết vòng lặp chờ cho đến khi **tất cả `N` job** được xử lý và có trạng thái `pendingVerification`.
        *   Dùng `Promise.all` để `N` renter đồng thời xác thực kết quả công việc của mình.
        *   **Điều kiện thành công cuối cùng:** Kiểm tra và khẳng định (assert) rằng **tất cả `N` job** đều có trạng thái cuối cùng là `completed`.

---

## 🚀 Quy trình thực hiện (Implementation Process)

1.  **Đề xuất Kế hoạch:** Gemini đã phân tích yêu cầu và đề xuất một `Kế hoạch thực thi` chi tiết.
2.  **Chờ phê duyệt:** Kế hoạch đã được bạn phê duyệt.
3.  **Thực thi:** Gemini đã tiến hành implement các thay đổi theo kế hoạch. Các file `provider-cli.ts` và `tests/node-link.ts` đã được tái cấu trúc thành công.
4.  **Xác minh (Build & Test):** `anchor build` đã chạy thành công. `anchor test` đã được chạy với `N=2` và sau đó là `N=10` (10 renter và 10 provider). Cả hai lần chạy đều thành công 100%, xác nhận hệ thống hoạt động ổn định dưới tải.
5.  **Hoàn tất:** Công việc đã hoàn thành. Bộ test mới mạnh mẽ, linh hoạt và thực tế hơn đã được đưa vào sử dụng.

---

## ✅ Kết quả cuối cùng (Final Result)

- **Tóm tắt:** Quá trình nâng cấp bộ test đã thành công mỹ mãn. Chúng ta đã thay thế bộ test cũ, lỗi thời bằng một kịch bản test tích hợp end-to-end hoàn toàn mới, có khả năng mở rộng linh hoạt thông qua hằng số `N`.
- **Xác minh:** Bài test đã được chạy thành công với `N=10`, mô phỏng 10 renter tạo job và 10 provider xử lý chúng đồng thời. Tất cả 10 job đều được hoàn thành chính xác, từ khâu tạo job, tính toán kết quả, cho đến xác thực và cập nhật trạng thái cuối cùng là `Completed`.
- **Kết luận:** Lỗ hổng bảo mật ban đầu đã được khắc phục triệt để và hệ thống đã chứng tỏ được sự ổn định và chính xác khi xử lý nhiều tác vụ đồng thời.

---

## 📚 Ghi chú & Tài liệu tham khảo (Notes & References)

*   Công việc này sẽ tái cấu trúc mạnh mẽ bộ test hiện có để phù hợp hơn với logic nghiệp vụ phức tạp của dự án.
*   File `tests/node-link.js` sẽ bị xóa.
