# 1.3: Xây dựng Logic Quản lý Tác vụ & Thanh toán An toàn

- **Người thực hiện (Implemented by):** [Khánh/Quân]
- **Liên quan đến Giai đoạn (Related to Phase):** 1

---

## 📝 Kế hoạch thực thi (Execution Plan)

*Phần này mô tả kế hoạch chi tiết sẽ được thực hiện. Gemini sẽ trình bày những gì sẽ làm và lý do tại sao. Công việc sẽ chỉ bắt đầu sau khi bạn đồng ý với kế hoạch này.*

**1. Mục tiêu (Goal):**
*   Xây dựng một luồng quản lý và thanh toán tác vụ an toàn, nơi Renter có thể tạo Job, Provider có thể gửi kết quả, và việc thanh toán được đảm bảo thông qua cơ chế tạm giữ (escrow) và thời hạn (deadline). Hệ thống cũng có khả năng xử lý khi kết quả sai và gán lại cho một Node khác.

**2. Lý do (Reason):**
*   Thiết kế này giải quyết lỗ hổng nghiêm trọng trong thiết kế ban đầu. Nó ngăn chặn việc Renter giữ tiền của Provider một cách ác ý và đảm bảo Provider được trả công xứng đáng. Việc gán lại job khi có lỗi giúp hệ thống linh hoạt và không phụ thuộc vào một node kém chất lượng.

**3. Các bước thực hiện (Steps):**
*   **Bước 1: Cập nhật `lib.rs` với các Structs & Enums mới:**
    *   Định nghĩa `JobStatus` enum: `{ Pending, InProgress, PendingVerification, Completed }`.
    *   Cập nhật `JobAccount`: Thêm các trường mới `status: JobStatus`, `results: [u8; 32]`, `verification_deadline: i64`, và **`failed_providers: Vec<Pubkey>`** (với giới hạn 5 providers) để lưu danh sách các node đã làm sai.
    *   Tạo một `EscrowAccount` (PDA) để khóa tiền thanh toán cho mỗi job.

*   **Bước 2: Viết và Cập nhật các Instructions:**
    *   **`create_job` (do Renter gọi):** Khởi tạo `JobAccount`, đặt trạng thái là `Pending`, và chuyển tiền vào `EscrowAccount`.
    *   **`accept_job` (do Provider gọi):** Một Provider mới sẽ gọi instruction này để nhận job. Instruction sẽ kiểm tra để đảm bảo Provider này **không có trong danh sách `failed_providers`**. Sau đó, cập nhật trạng thái job thành `InProgress`, trạng thái của Provider thành `Busy`, và gán `provider` hiện tại cho job.
    *   **`submit_result` (do Provider gọi):** Chỉ Provider đang thực hiện job mới gọi được. Instruction này sẽ lưu kết quả, cập nhật trạng thái thành `PendingVerification`, và đặt `verification_deadline`.
    *   **`verify_job` (do Renter gọi):** Instruction này sẽ nhận một tham số `is_correct: bool`.
        *   **Nếu `is_correct` là `true`:** Chuyển tiền từ `EscrowAccount` cho Provider, cập nhật trạng thái thành `Completed`.
        *   **Nếu `is_correct` là `false`:** Không chuyển tiền. Thêm Provider hiện tại vào danh sách `failed_providers`, và reset trạng thái job về `Pending` để node khác có thể nhận.
    *   **`claim_payment` (do Provider gọi):** Chỉ Provider đang thực hiện job mới gọi được. Instruction này chỉ thành công khi `verification_deadline` đã hết hạn. Nó sẽ tự động chuyển tiền từ escrow cho Provider.

*   **Bước 3: Cập nhật Toàn diện Unit Tests (`tests/node-link.ts`):**
    *   Viết test case cho luồng thành công: create -> accept -> submit -> verify(true) -> payment.
    *   Viết test case cho luồng Renter không phản hồi: create -> accept -> submit -> chờ hết hạn -> provider claim payment.
    *   Viết test case cho luồng kết quả sai: create -> accept -> submit -> verify(false) -> job reset -> **node khác** accept job.

---

## 🚀 Quy trình thực hiện (Implementation Process)

*... (giữ nguyên)*

---

## 📚 Ghi chú & Tài liệu tham khảo (Notes & References)

*... (giữ nguyên)*