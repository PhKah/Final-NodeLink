# 1.3: XÃ¢y dá»±ng Logic Quáº£n lÃ½ TÃ¡c vá»¥ & Thanh toÃ¡n An toÃ n

- **NgÆ°á»i thá»±c hiá»‡n (Implemented by):** [KhÃ¡nh/QuÃ¢n]
- **LiÃªn quan Ä‘áº¿n Giai Ä‘oáº¡n (Related to Phase):** 1

---

## ğŸ“ Káº¿ hoáº¡ch thá»±c thi (Execution Plan)

*Pháº§n nÃ y mÃ´ táº£ káº¿ hoáº¡ch chi tiáº¿t sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n. Gemini sáº½ trÃ¬nh bÃ y nhá»¯ng gÃ¬ sáº½ lÃ m vÃ  lÃ½ do táº¡i sao. CÃ´ng viá»‡c sáº½ chá»‰ báº¯t Ä‘áº§u sau khi báº¡n Ä‘á»“ng Ã½ vá»›i káº¿ hoáº¡ch nÃ y.*

**1. Má»¥c tiÃªu (Goal):**
*   XÃ¢y dá»±ng má»™t luá»“ng quáº£n lÃ½ vÃ  thanh toÃ¡n tÃ¡c vá»¥ an toÃ n, nÆ¡i Renter cÃ³ thá»ƒ táº¡o Job, Provider cÃ³ thá»ƒ gá»­i káº¿t quáº£, vÃ  viá»‡c thanh toÃ¡n Ä‘Æ°á»£c Ä‘áº£m báº£o thÃ´ng qua cÆ¡ cháº¿ táº¡m giá»¯ (escrow) vÃ  thá»i háº¡n (deadline). Há»‡ thá»‘ng cÅ©ng cÃ³ kháº£ nÄƒng xá»­ lÃ½ khi káº¿t quáº£ sai vÃ  gÃ¡n láº¡i cho má»™t Node khÃ¡c.

**2. LÃ½ do (Reason):**
*   Thiáº¿t káº¿ nÃ y giáº£i quyáº¿t lá»— há»•ng nghiÃªm trá»ng trong thiáº¿t káº¿ ban Ä‘áº§u. NÃ³ ngÄƒn cháº·n viá»‡c Renter giá»¯ tiá»n cá»§a Provider má»™t cÃ¡ch Ã¡c Ã½ vÃ  Ä‘áº£m báº£o Provider Ä‘Æ°á»£c tráº£ cÃ´ng xá»©ng Ä‘Ã¡ng. Viá»‡c gÃ¡n láº¡i job khi cÃ³ lá»—i giÃºp há»‡ thá»‘ng linh hoáº¡t vÃ  khÃ´ng phá»¥ thuá»™c vÃ o má»™t node kÃ©m cháº¥t lÆ°á»£ng.

**3. CÃ¡c bÆ°á»›c thá»±c hiá»‡n (Steps):**
*   **BÆ°á»›c 1: Cáº­p nháº­t `lib.rs` vá»›i cÃ¡c Structs & Enums má»›i:**
    *   Äá»‹nh nghÄ©a `JobStatus` enum: `{ Pending, InProgress, PendingVerification, Completed }`.
    *   Cáº­p nháº­t `JobAccount`: ThÃªm cÃ¡c trÆ°á»ng má»›i `status: JobStatus`, `results: [u8; 32]`, `verification_deadline: i64`, vÃ  **`failed_providers: Vec<Pubkey>`** (vá»›i giá»›i háº¡n 5 providers) Ä‘á»ƒ lÆ°u danh sÃ¡ch cÃ¡c node Ä‘Ã£ lÃ m sai.
    *   Táº¡o má»™t `EscrowAccount` (PDA) Ä‘á»ƒ khÃ³a tiá»n thanh toÃ¡n cho má»—i job.

*   **BÆ°á»›c 2: Viáº¿t vÃ  Cáº­p nháº­t cÃ¡c Instructions:**
    *   **`create_job` (do Renter gá»i):** Khá»Ÿi táº¡o `JobAccount`, Ä‘áº·t tráº¡ng thÃ¡i lÃ  `Pending`, vÃ  chuyá»ƒn tiá»n vÃ o `EscrowAccount`.
    *   **`accept_job` (do Provider gá»i):** Má»™t Provider má»›i sáº½ gá»i instruction nÃ y Ä‘á»ƒ nháº­n job. Instruction sáº½ kiá»ƒm tra Ä‘á»ƒ Ä‘áº£m báº£o Provider nÃ y **khÃ´ng cÃ³ trong danh sÃ¡ch `failed_providers`**. Sau Ä‘Ã³, cáº­p nháº­t tráº¡ng thÃ¡i job thÃ nh `InProgress`, tráº¡ng thÃ¡i cá»§a Provider thÃ nh `Busy`, vÃ  gÃ¡n `provider` hiá»‡n táº¡i cho job.
    *   **`submit_result` (do Provider gá»i):** Chá»‰ Provider Ä‘ang thá»±c hiá»‡n job má»›i gá»i Ä‘Æ°á»£c. Instruction nÃ y sáº½ lÆ°u káº¿t quáº£, cáº­p nháº­t tráº¡ng thÃ¡i thÃ nh `PendingVerification`, vÃ  Ä‘áº·t `verification_deadline`.
    *   **`verify_job` (do Renter gá»i):** Instruction nÃ y sáº½ nháº­n má»™t tham sá»‘ `is_correct: bool`.
        *   **Náº¿u `is_correct` lÃ  `true`:** Chuyá»ƒn tiá»n tá»« `EscrowAccount` cho Provider, cáº­p nháº­t tráº¡ng thÃ¡i thÃ nh `Completed`.
        *   **Náº¿u `is_correct` lÃ  `false`:** KhÃ´ng chuyá»ƒn tiá»n. ThÃªm Provider hiá»‡n táº¡i vÃ o danh sÃ¡ch `failed_providers`, vÃ  reset tráº¡ng thÃ¡i job vá» `Pending` Ä‘á»ƒ node khÃ¡c cÃ³ thá»ƒ nháº­n.
    *   **`claim_payment` (do Provider gá»i):** Chá»‰ Provider Ä‘ang thá»±c hiá»‡n job má»›i gá»i Ä‘Æ°á»£c. Instruction nÃ y chá»‰ thÃ nh cÃ´ng khi `verification_deadline` Ä‘Ã£ háº¿t háº¡n. NÃ³ sáº½ tá»± Ä‘á»™ng chuyá»ƒn tiá»n tá»« escrow cho Provider.

*   **BÆ°á»›c 3: Cáº­p nháº­t ToÃ n diá»‡n Unit Tests (`tests/node-link.ts`):**
    *   Viáº¿t test case cho luá»“ng thÃ nh cÃ´ng: create -> accept -> submit -> verify(true) -> payment.
    *   Viáº¿t test case cho luá»“ng Renter khÃ´ng pháº£n há»“i: create -> accept -> submit -> chá» háº¿t háº¡n -> provider claim payment.
    *   Viáº¿t test case cho luá»“ng káº¿t quáº£ sai: create -> accept -> submit -> verify(false) -> job reset -> **node khÃ¡c** accept job.

---

## ğŸš€ Quy trÃ¬nh thá»±c hiá»‡n (Implementation Process)

*... (giá»¯ nguyÃªn)*

---

## ğŸ“š Ghi chÃº & TÃ i liá»‡u tham kháº£o (Notes & References)

*... (giá»¯ nguyÃªn)*