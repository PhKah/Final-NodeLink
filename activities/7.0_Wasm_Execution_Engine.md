# TÃªn cÃ´ng viá»‡c: 7.0 - TÃ­ch há»£p Wasm Runtime vÃ  Thá»±c thi Job

- **NgÆ°á»i thá»±c hiá»‡n (Implemented by):** Gemini & KhÃ¡nh
- **LiÃªn quan Ä‘áº¿n Giai Ä‘oáº¡n (Related to Phase):** 2 & 5

---

## ğŸ“ Káº¿ hoáº¡ch thá»±c thi (Execution Plan)

*Pháº§n nÃ y mÃ´ táº£ káº¿ hoáº¡ch chi tiáº¿t sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n. Vá»›i chuyÃªn mÃ´n vá» WebAssembly, tÃ´i sáº½ trÃ¬nh bÃ y cÃ¡c bÆ°á»›c ká»¹ thuáº­t cáº§n thiáº¿t Ä‘á»ƒ xÃ¢y dá»±ng má»™t trÃ¬nh thá»±c thi an toÃ n vÃ  hiá»‡u quáº£.*

**1. Má»¥c tiÃªu (Goal):**
*   NÃ¢ng cáº¥p `provider-cli` tá»« má»™t daemon chá»‰ biáº¿t "nháº­n viá»‡c" thÃ nh má»™t "cÃ´ng nhÃ¢n" thá»±c thá»¥. Má»¥c tiÃªu lÃ  giÃºp daemon cÃ³ kháº£ nÄƒng táº£i vá» má»™t job tá»« IPFS, Ä‘á»c `manifest.json`, thá»±c thi file WebAssembly (Wasm) tÆ°Æ¡ng á»©ng, vÃ  gá»­i tráº£ káº¿t quáº£ má»™t cÃ¡ch hoÃ n chá»‰nh.

**2. LÃ½ do (Reason):**
*   ÄÃ¢y lÃ  bÆ°á»›c hiá»‡n thá»±c hÃ³a pháº§n "tÃ­nh toÃ¡n" (Compute) trong mÃ´ hÃ¬nh DePIN (Decentralized Physical Infrastructure Networks) cá»§a chÃºng ta. Náº¿u khÃ´ng cÃ³ bÆ°á»›c nÃ y, toÃ n bá»™ há»‡ thá»‘ng chá»‰ lÃ  má»™t chuá»—i cÃ¡c giao dá»‹ch on-chain mÃ  khÃ´ng táº¡o ra báº¥t ká»³ giÃ¡ trá»‹ tÃ­nh toÃ¡n thá»±c táº¿ nÃ o. Viá»‡c thá»±c thi Wasm vÃ  tráº£ vá» káº¿t quáº£ lÃ  luá»“ng cÃ´ng viá»‡c cá»‘t lÃµi cá»§a má»™t Provider.

**3. CÃ¡c bÆ°á»›c thá»±c hiá»‡n (Steps):**

*   **BÆ°á»›c 1: Thiáº¿t láº­p MÃ´i trÆ°á»ng & Dependencies**
    *   ChÃºng ta cáº§n hai thÆ° viá»‡n chÃ­nh. TÃ´i sáº½ thÃªm chÃºng vÃ o `package.json`:
        1.  `kubo-rpc-client`: ThÆ° viá»‡n client chÃ­nh thá»©c Ä‘á»ƒ giao tiáº¿p vá»›i IPFS daemon Ä‘ang cháº¡y trÃªn mÃ¡y cá»§a Provider.
        2.  `@wasmer/sdk`: Má»™t Wasm runtime máº¡nh máº½, há»— trá»£ Ä‘áº§y Ä‘á»§ chuáº©n WASI, cho phÃ©p chÃºng ta cháº¡y cÃ¡c module Wasm vÃ  kiá»ƒm soÃ¡t cháº·t cháº½ quyá»n truy cáº­p há»‡ thá»‘ng cá»§a chÃºng.
    *   *Thao tÃ¡c: Cháº¡y `npm install kubo-rpc-client @wasmer/sdk`.*

*   **BÆ°á»›c 2: Implement HÃ m Táº£i Job tá»« IPFS (`downloadJobDirectory`)**
    *   Táº¡o má»™t hÃ m helper `async function downloadJobDirectory(cid)` trong `provider-cli.ts`.
    *   HÃ m nÃ y sáº½ káº¿t ná»‘i tá»›i IPFS daemon cá»¥c bá»™ (máº·c Ä‘á»‹nh lÃ  `http://127.0.0.1:5001`).
    *   NÃ³ sáº½ táº¡o má»™t thÆ° má»¥c táº¡m duy nháº¥t trÃªn há»‡ thá»‘ng file cá»§a Provider.
    *   NÃ³ sáº½ táº£i toÃ n bá»™ ná»™i dung cá»§a thÆ° má»¥c tÆ°Æ¡ng á»©ng vá»›i `cid` tá»« IPFS vÃ o thÆ° má»¥c táº¡m nÃ y.
    *   HÃ m sáº½ tráº£ vá» Ä‘Æ°á»ng dáº«n Ä‘áº¿n thÆ° má»¥c táº¡m.

*   **BÆ°á»›c 3: Implement HÃ m Thá»±c thi Wasm (`executeWasmJob`)**
    *   ÄÃ¢y lÃ  bÆ°á»›c quan trá»ng nháº¥t. Táº¡o hÃ m `async function executeWasmJob(jobDirectoryPath)`.
    *   **Äá»c Manifest:** HÃ m sáº½ Ä‘á»c vÃ  parse file `manifest.json` tá»« `jobDirectoryPath` Ä‘á»ƒ láº¥y ra `executable` vÃ  `args`.
    *   **Khá»Ÿi táº¡o Wasmer vá»›i WASI:** ChÃºng ta sáº½ khá»Ÿi táº¡o má»™t instance Wasmer. Äiá»ƒm máº¥u chá»‘t á»Ÿ Ä‘Ã¢y lÃ  cáº¥u hÃ¬nh **WASI (WebAssembly System Interface)**:
        *   ChÃºng ta sáº½ "map" thÆ° má»¥c `jobDirectoryPath` trÃªn mÃ¡y tháº­t vÃ o thÆ° má»¥c gá»‘c `/` áº£o bÃªn trong sandbox cá»§a Wasm.
        *   Äiá»u nÃ y cÃ³ nghÄ©a lÃ  file Wasm khi cháº¡y sáº½ tháº¥y cÃ¡c file `input.json`, `script.wasm`... nhÆ° thá»ƒ chÃºng Ä‘ang á»Ÿ thÆ° má»¥c gá»‘c. NÃ³ **khÃ´ng thá»ƒ** nhÃ¬n tháº¥y báº¥t ká»³ file nÃ o khÃ¡c trÃªn mÃ¡y cá»§a Provider. ÄÃ¢y chÃ­nh lÃ  cÆ¡ cháº¿ báº£o máº­t cá»‘t lÃµi.
    *   **Thá»±c thi:** Cháº¡y module Wasm vá»›i cÃ¡c `args` Ä‘Ã£ Ä‘á»c tá»« manifest.
    *   **Logging:** Thu láº¡i `stdout` vÃ  `stderr` tá»« tiáº¿n trÃ¬nh Wasm Ä‘á»ƒ ghi log, giÃºp cho viá»‡c gá»¡ lá»—i.
    *   HÃ m sáº½ tráº£ vá» Ä‘Æ°á»ng dáº«n Ä‘áº¿n file/folder káº¿t quáº£ (dá»±a trÃªn `output_path` trong manifest).

*   **BÆ°á»›c 4 (Má»›i): Implement HÃ m Xá»­ lÃ½ vÃ  Táº¡o "GÃ³i Káº¿t quáº£"**
    *   Sau khi `executeWasmJob` cháº¡y xong, táº¡o má»™t thÆ° má»¥c táº¡m má»›i cho gÃ³i káº¿t quáº£ (vÃ­ dá»¥: `result_pkg`).
    *   LÆ°u `stdout` vÃ  `stderr` Ä‘Ã£ thu Ä‘Æ°á»£c vÃ o cÃ¡c file `result_pkg/stdout.txt` vÃ  `result_pkg/stderr.txt`.
    *   Di chuyá»ƒn/copy káº¿t quáº£ chÃ­nh tá»« `outputPath` vÃ o má»™t thÆ° má»¥c con, vÃ­ dá»¥: `result_pkg/output/`.
    *   Táº¡o má»™t hÃ m helper `async function uploadToIpfs(directoryPath)` Ä‘á»ƒ táº£i toÃ n bá»™ thÆ° má»¥c `result_pkg` nÃ y lÃªn IPFS vÃ  tráº£ vá» `resultCid`.

*   **BÆ°á»›c 5 (Cáº­p nháº­t): TÃ­ch há»£p ToÃ n bá»™ Luá»“ng vÃ o VÃ²ng láº·p `listen`**
    *   Trong file `provider-cli.ts`, sau khi má»™t job Ä‘Æ°á»£c cháº¥p nháº­n thÃ nh cÃ´ng:
    1.  Gá»i `downloadJobDirectory()` Ä‘á»ƒ láº¥y dá»¯ liá»‡u job vá» thÆ° má»¥c táº¡m.
    2.  Gá»i `executeWasmJob()` vÃ  nháº­n vá» má»™t object chá»©a `outputPath`, `stdout`, `stderr`.
    3.  Táº¡o thÆ° má»¥c "GÃ³i Káº¿t quáº£" vÃ  Ä‘iá»n cÃ¡c file `stdout.txt`, `stderr.txt`, vÃ  output chÃ­nh vÃ o Ä‘Ã³.
    4.  Gá»i `uploadToIpfs()` vá»›i Ä‘Æ°á»ng dáº«n cá»§a "GÃ³i Káº¿t quáº£" Ä‘á»ƒ nháº­n vá» `resultCid`.
    5.  Gá»i `program.methods.submitResults(resultCid)` Ä‘á»ƒ bÃ¡o cÃ¡o káº¿t quáº£ lÃªn blockchain.
    6.  Thá»±c hiá»‡n dá»n dáº¹p cáº£ thÆ° má»¥c job vÃ  thÆ° má»¥c káº¿t quáº£ táº¡m.

---

## ğŸš€ Quy trÃ¬nh thá»±c hiá»‡n (Implementation Process)

1.  **Äá» xuáº¥t Káº¿ hoáº¡ch:** TÃ´i Ä‘Ã£ trÃ¬nh bÃ y káº¿ hoáº¡ch chi tiáº¿t, Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t á»Ÿ trÃªn.
2.  **Chá» phÃª duyá»‡t:** TÃ´i Ä‘ang Ä‘á»£i báº¡n xÃ¡c nháº­n Ä‘á»“ng Ã½ vá»›i káº¿ hoáº¡ch nÃ y.
3.  **Thá»±c thi:** Sau khi báº¡n Ä‘á»“ng Ã½, tÃ´i sáº½ tiáº¿n hÃ nh implement cÃ¡c thay Ä‘á»•i theo tá»«ng bÆ°á»›c Ä‘Ã£ váº¡ch ra.
4.  **XÃ¡c minh (Build & Test):** Sau má»—i bÆ°á»›c, chÃºng ta cáº§n cháº¡y thá»­ `provider-cli` vá»›i má»™t job máº«u (Ä‘Æ°á»£c táº¡o thá»§ cÃ´ng) Ä‘á»ƒ Ä‘áº£m báº£o cÃ¡c hÃ m hoáº¡t Ä‘á»™ng Ä‘Ãºng.
5.  **HoÃ n táº¥t:** HoÃ n thÃ nh viá»‡c tÃ­ch há»£p toÃ n bá»™ luá»“ng xá»­ lÃ½ job vÃ o vÃ²ng láº·p `listen`.

---

## ğŸ“š Ghi chÃº & TÃ i liá»‡u tham kháº£o (Notes & References)

*   **YÃªu cáº§u tiÃªn quyáº¿t:** Provider pháº£i cÃ i Ä‘áº·t vÃ  cháº¡y má»™t IPFS daemon (Kubo) trÃªn mÃ¡y cá»§a há».
*   **TÃ i liá»‡u tham kháº£o:**
    *   Wasmer JS SDK: [https://www.npmjs.com/package/@wasmer/sdk](https://www.npmjs.com/package/@wasmer/sdk)
    *   Kubo RPC Client: [https://www.npmjs.com/package/kubo-rpc-client](https://www.npmjs.com/package/kubo-rpc-client)
    *   WASI (WebAssembly System Interface): [https://wasi.dev/](https://wasi.dev/)